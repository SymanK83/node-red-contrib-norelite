<!-- *********************************************
    source node
     ********************************************* -->
<script type="text/x-red" data-template-name="nrl-source out">
    <div class="form-row">
        <label for="node-input-config"><i class="fa fa-bookmark"></i> Config</label>
        <input type="text" id="node-input-config">
    </div>
    <div class="form-row" id="default-details">
        <label for="node-input-def"><i class="fa fa-bookmark"></i> Initial value</label>
        <input type="text" id="node-input-def">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-expire" placeholder="Only" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-expire" style="width: 70%;">Value can expire</label>
    </div>
    <div id="expire-details">
        <div class="form-row">
            <label for="node-input-timeout"><i class="fa fa-clock-o"></i> For</label>
            <input type="text" id="node-input-timeout" placeholder="Time" style="direction:rtl; width:50px !important">
            <select id="node-input-timeoutUnits" style="width:200px !important">
              <option value="milliseconds">Milliseconds</option>
              <option value="seconds">Seconds</option>
              <option value="minutes">Minutes</option>
              <option value="hours">Hours</option>
              <option value="days">Days</option>
            </select>
        </div>
        <div class="form-row" id="expire-value">
            <label for="node-input-expval"><i class="fa fa-bookmark"></i> Expiration value</label>
            <input type="text" id="node-input-expval">
        </div>
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-toggle" placeholder="Only" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-toggle" style="width: 70%;">Toggle (0/1)</label>
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-output" placeholder="Only" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-output" style="width: 70%;">Use output</label>
    </div>
    <div class="form-row" id="hysteresis-details">
        <label for="node-input-hysteresis"><i class="fa fa-bookmark"></i> Hysteresis</label>
        <input type="text" id="node-input-hysteresis" style="width:50px">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-bookmark"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

</script>
<script type="text/x-red" data-help-name="nrl-source out">
<p>Stores the received value and will trigger any <b>nrl-eval</b> nodes that have rules that are using this node for evaluation.</p><p><b>Config</b> is used to set some global configuration variables. use the same configuration for all nrl-eval nodes and nrl-sources nodes that should be able to communicate (e.g. source sends new values to nrl-eval nodes for evaluation in the rules). <b>Rule delay</b> value is used for rules to wait before sending out a message as sometimes multiple sources gets updated close to each other and this variable can avoid unnecessary output messages. Rule delay can be overridden in the nrl-eval node if needed.</p><p><b>Initial value</b> is sent, when the node is deploy, as a start value. If you want to wait for the first incoming message simply clear this field.</p><p><b>Value can expire</b> is used to set an expiration on the incoming value and the value to be sent when it has expired. If Toggle is enabled the reset value will be '0'.</p><p><b>Toggle (0/1)</b> will initially send an '0' upon deploy and for each incoming message it will simply toggle between '0' and '1'. If Value can expire is set the expiration value is '0'.</p><p><b>Use output </b>can be used to send the value of the node further to any other node.</p><p><b>Hysteresis</b> number is used to avoid switching on/off if the values are closed to what has been set in the rules. E.g. 0.1 if you would require a new value to be at least 0.1 from the previous value in order to have the value changed. This is only applicable for numbers and not strings and it should be a positive number (&gt;=0). If set to 0 it is disabled.</p><p><b>Name</b> is important as it will be used in the rule node (nrl-rule).</p>
</script>
<script type="text/javascript">
  function oneditprepareDatasource() {
    $("#node-input-expire").change(function() {
      if ($("#node-input-expire").is(':checked')) {
        $("#expire-details").show();
      } else {
        $("#expire-details").hide();
      }
    });
    $("#node-input-toggle").change(function() {
      if ($("#node-input-toggle").is(':checked')) {
        $("#default-details").hide();
        $("#expire-value").hide();
        $("#hysteresis-details").hide();
      } else {
        $("#default-details").show();
        $("#expire-value").show();
        $("#hysteresis-details").show();
      }
    });
  }
  RED.nodes.registerType('nrl-source out', {
    category: 'norelite-output',
    color: "#E2D96E",
    defaults: {
      config: {
        type: "nrl-config",
        required: true
      },
      name: {
        value: "",
        required: true
      },
      def: {
        value: "",
        required: false
      },
      expire: {
        value: false,
        required: true
      },
      timeout: {
        value: 100,
        required: false,
        validate: RED.validators.number()
      },
      timeoutUnits: {
        value: "seconds",
        required: false
      },
      expval: {
        value: false,
        required: false
      },
      output: {
        value: false,
        required: true
      },
      hysteresis: {
        value: 0,
        required: true,
        validate: RED.validators.number()
      },
      toggle: {
        value: false,
        required: true
      },
      outputs: {
        value: 0
      } //Storing if outputs is enabled. To be able to copy the node.
    },
    inputs: 1,
    outputs: 0,
    icon: "fa-hdd-o.png",
    align: "right",
    label: function() {
      return (this.name || "undefined");
    },
    oneditprepare: oneditprepareDatasource,
    oneditsave: function() {
      var node = this;
      if ($("#node-input-output").is(":checked")) {
        node.outputs = 1;
      } else {
        node.outputs = 0;
      }
      //Set default value =0 when toggle mode is on
      //and hysteresis to 0
      if ($("#node-input-toggle").is(":checked")) {
        $("#node-input-def").val('0');
        $("#node-input-hysteresis").val('0');
        //If expiration is set, set the expiration value to 0
        if ($("#node-input-expire").is(":checked")) {
          $("#node-input-expval").val('0');
        }
      }
    }
  });
</script>
